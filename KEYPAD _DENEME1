; =====================================================
; AKILLI EV – BOARD 1 (DISPLAY SCAN FIX)
; =====================================================

#include <xc.inc>

; ---------------- CONFIG ----------------
CONFIG FOSC = HS
CONFIG WDTE = OFF
CONFIG PWRTE = ON
CONFIG BOREN = ON
CONFIG LVP = OFF
CONFIG CPD = OFF
CONFIG WRT = OFF
CONFIG CP = OFF

; ---------------- RAM ----------------
PSECT udata_shr
W_TEMP:         DS 1
STATUS_TEMP:    DS 1
DIGIT_TEMP:     DS 1    ; Tarama için geçici saklama

PSECT udata_bank0
DIGIT_VAR:      DS 1
DISP1:          DS 1    ; Onlar
DISP2:          DS 1    ; Birler
DISP3:          DS 1    ; Ondalık
DISP4:          DS 1    ; C Harfi
TEMP_RAW:       DS 1
TEMP_CALIB:     DS 1
TEMP_OFFSET:    DS 1
ADC_LOW:        DS 1
; Mevcut degiskenlerinin altina bunu ekle:
REQ_DESIRED_TEMP:   DS 1    ; Istenen Sicaklik (Sabit test icin)
; --- KEYPAD DEGISKENLERI ---
KEY_CODE:       DS 1    ; Basilan tusun kodu (0-9, A, B...)
KEY_FLAG:       DS 1    ; Tus basildi mi? (1=Evet, 0=Hayir)
INPUT_MODE:     DS 1    ; 1=Veri Giris Modu, 0=Normal Mod
GIRILEN_SAYI:   DS 1    ; Kullanicinin o an girdigi sayi
SAYAC_TUS:      DS 1    ; Tus arkini onlemek (Debounce) icin sayac

; ---------------- RESET ----------------
PSECT code, delta=2, abs
ORG 0x0000
    GOTO MAIN

; ---------------- INTERRUPT ----------------
PSECT code, delta=2, abs
ORG 0x0004
ISR:
    MOVWF   W_TEMP
    SWAPF   STATUS, W
    MOVWF   STATUS_TEMP

    BCF     STATUS, 5       ; Bank 0
    BCF     STATUS, 6

    BCF     INTCON, 2       ; T0IF Temizle
    CALL    REFRESH_DISPLAY
    MOVLW   100
    MOVWF   TMR0

    SWAPF   STATUS_TEMP, W
    MOVWF   STATUS
    SWAPF   W_TEMP, F
    SWAPF   W_TEMP, W
    RETFIE

; ---------------- 7-SEGMENT TABLOSU ----------------
PSECT code, delta=2, abs
ORG 0x0200

GET_7SEG:
    ANDLW   0x0F
    ADDWF   PCL, F

    ; Common Cathode (1 = YANAR)
    RETLW   00111111B ; 0
    RETLW   00000110B ; 1
    RETLW   01011011B ; 2
    RETLW   01001111B ; 3
    RETLW   01100110B ; 4
    RETLW   01101101B ; 5
    RETLW   01111101B ; 6
    RETLW   00000111B ; 7
    RETLW   01111111B ; 8
    RETLW   01101111B ; 9
    RETLW   00111001B ; C (10)
    RETLW   01100011B ; Derece (11)
    RETLW   00000000B ; Boş

; ---------------- MAIN ----------------
PSECT code
MAIN:
    ; PORT AYARLARI
    BANKSEL TRISD
    CLRF    TRISD
    CLRF    TRISE
    CLRF    TRISA
    BSF     TRISA, 0        ; RA0 Analog

    ; ADC AYARI
    MOVLW   10001110B       
    MOVWF   ADCON1
    BANKSEL ADCON0
    MOVLW   10000001B       ; ADC Açık
    MOVWF   ADCON0

    ; TIMER AYARLARI
    ; TIMER AYARLARI KISMINDAKI DEGİSİKLİK
    BANKSEL OPTION_REG
    MOVLW   00000100B       ; <-- DIKKAT: En bastaki bit 0 yapildi (Pull-up ACIK)
    MOVWF   OPTION_REG
    BANKSEL INTCON
    MOVLW   10100000B       ; Kesmeler Açık
    MOVWF   INTCON

    BANKSEL PORTD
    CLRF    DIGIT_VAR
    
    MOVLW   10              ; 'C' harfi
    MOVWF   DISP4
    ; ... (Ayarlar bittikten sonra) ...
    CLRF    DIGIT_VAR
    
    MOVLW   10              ; 'C' harfi
    MOVWF   DISP4

    ; --- YENI EKLENEN KISIM ---
    MOVLW   25              ; Hedef sicaklik 25 derece olsun
    MOVWF   REQ_DESIRED_TEMP
    ; --------------------------

MAIN_LOOP:
    ; 1. Keypad Tara
    CALL    SCAN_KEYPAD
    
    ; 2. Tus Basildi mi?
    MOVF    KEY_FLAG, F
    BTFSS   STATUS, 2       ; Z=1 ise (0 ise) basilmamis demektir atla
    CALL    ISLE_TUS        ; Basilmissa tusu isleyen fonksiyona git

    ; 3. Mod Kontrolü
    ; Eger INPUT_MODE = 1 ise ekranda GIRILEN_SAYI gosterilmeli.
    ; Eger INPUT_MODE = 0 ise sensorden okunan sicaklik gosterilmeli.
    
    MOVF    INPUT_MODE, F
    BTFSS   STATUS, 2       ; Z=1 (Mode 0) ise atla
    GOTO    MOD_GIRIS       ; Mode 1 ise giris ekranini goster

MOD_NORMAL:
    ; --- NORMAL MOD (SENSOR OKU VE GOSTER) ---
    CALL    READ_ADC        ; Sensoru oku
    CALL    CHECK_TEMP_CONTROL ; Klimayi kontrol et (Isitici/Sogutucu)
    CALL    SPLIT_DIGITS    ; Okunan sicakligi basamaklara ayir
    GOTO    DONGU_SONU

MOD_GIRIS:
    ; --- GIRIS MODU (GIRILEN SAYIYI GOSTER) ---
    ; GIRILEN_SAYI degiskenini basamaklara ayirip ekrana basacagiz
    CLRF    DISP1           ; Onlar (Simdilik basit tutalim)
    MOVF    GIRILEN_SAYI, W
    MOVWF   TEMP_RAW        ; Split fonksiyonu TEMP_RAW kullaniyor
    CALL    SPLIT_DIGITS    ; Sayiyi ayir (DISP1, DISP2...)
    ; Ondalik ve C harfini kapatalim karisiklik olmasin
    MOVLW   12              ; Bos
    MOVWF   DISP3
    MOVWF   DISP4
    
DONGU_SONU:
    CALL    DELAY_SMALL
    GOTO    MAIN_LOOP

; ---------------- TUS ISLEME MANTIGI ----------------
ISLE_TUS:
    ; 1. 'A' Tusu (Giris Baslat)
    MOVF    KEY_CODE, W
    XORLW   0x0A            ; A mi?
    BTFSC   STATUS, 2       ; Esitse atla
    GOTO    A_BASILDI
    
    ; 2. '#' Tusu (Onayla / Enter)
    MOVF    KEY_CODE, W
    XORLW   0x0F            ; Kare (#) mi?
    BTFSC   STATUS, 2
    GOTO    KARE_BASILDI
    
    ; 3. Rakamlar (0-9)
    ; Eger Giris Modunda degilsek rakamlari umursama
    MOVF    INPUT_MODE, F
    BTFSC   STATUS, 2       ; Mode=0 ise cik
    RETURN
    
    ; Rakam mi? (0-9 arasinda mi kontrolu yapilabilir ama simdilik guvenelim)
    MOVF    KEY_CODE, W
    SUBLW   9               ; 9 - Key
    BTFSS   STATUS, 0       ; Key > 9 ise C=0 olur
    RETURN                  ; Rakam degilse cik (B, C, D, * gibi)

    ; Rakam basildi. Sayiyi olustur.
    ; Mantik: Yeni Sayi = (Eski Sayi * 10) + Yeni Rakam
    ; Basitlik icin sadece 2 haneli girelim:
    ; Eger sayi 0 ise direkt kaydet. Sayi 0 degilse onlar basamagi yap.
    
    ; Simdilik cok basit yapalim: Sadece son basilan rakami alalim test icin.
    ; Ileri seviyede (25) yazmak icin kaydirma yapacagiz.
    
    ; Algoritma: GIRILEN_SAYI = (GIRILEN_SAYI * 10) + KEY_CODE
    ; Carpma islemi PIC'te zor, basit toplama ile yapalim: Sayi = Sayi + Sayi (x2) ...
    
    ; --- BASIT YONTEM (Onlar ve Birler Ayri Girilmez) ---
    ; Onceki sayiyi 10 ile carp
    MOVF    GIRILEN_SAYI, W
    MOVWF   W_TEMP          ; Yedekle
    ADDWF   GIRILEN_SAYI, F ; x2
    ADDWF   GIRILEN_SAYI, F ; x3 ... bu uzun.
    
    ; Kisa yol: Eger onceki sayi 0'dan buyukse, bu ikinci rakamdir.
    ; Yani once 2'ye basti (Sayi=2). Sonra 5'e basti.
    ; Sayi = (2 * 10) + 5 = 25 olmali.
    ; Assembly'de carpma yok, o yuzden soyle yapalim:
    ; Direkt onceki sayiyi silip yenisini yazalim SIMDILIK. (Test kolay olsun)
    ; Veya soyle yapalim:
    ; GIRILEN_SAYI degiskenine direkt KEY_CODE atalim. 
    ; (Boylece sadece 0-9 arasi sicaklik girebilirsin, ama sistem calisir).
    ; 25 girmek icin algoritma lazim. Istersen onu da yazarim.
    
    ; --- GELISMIS YONTEM (Carpma Islemi) ---
    ; W_TEMP = Eski Sayi
    MOVF    GIRILEN_SAYI, W
    MOVWF   W_TEMP
    
    ; 10 ile carp: (x8 + x2)
    BCF     STATUS, 0       ; C temizle
    RLF     GIRILEN_SAYI, F ; x2
    BCF     STATUS, 0
    RLF     GIRILEN_SAYI, F ; x4
    BCF     STATUS, 0
    RLF     GIRILEN_SAYI, F ; x8
    
    ; Simdi x8 (GIRILEN_SAYI) + x2 (W_TEMP * 2) yapmamiz lazim. Karisik oldu.
    ; Geri alalim. En basit hali:
    ; Kullanici once onlar basamagini, sonra birler basamagini girsin mantigi zor.
    
    ; --- EN BASIT VE CALISAN YONTEM ---
    ; Eger sayi > 9 ise sifirla (yeni giris).
    ; Degilse: Onlar basamagi var demektir. 
    ; Biz su anlik sadece TEK BASAMAKLI veya ONCEKINI SILEN mantik kuralim.
    ; GIRILEN_SAYI = (GIRILEN_SAYI * 10) + KEY
    
    ; Carpma rutinini pas geciyorum, direkt atama yapiyorum ki kafa karismasin.
    ; Kullanici: 2'ye basarsa Hedef=2. 5'e basarsa Hedef=5 olur.
    ; Iki basamakli yapmak istersen soyle, hemen carpma kodunu eklerim.
    
    MOVF    KEY_CODE, W
    MOVWF   GIRILEN_SAYI
    RETURN

A_BASILDI:
    ; Modu 1 yap, ekrani temizle
    MOVLW   1
    MOVWF   INPUT_MODE
    CLRF    GIRILEN_SAYI
    RETURN

KARE_BASILDI:
    ; Modu 0 yap, girilen sayiyi HEDEF olarak kaydet
    CLRF    INPUT_MODE
    MOVF    GIRILEN_SAYI, W
    MOVWF   REQ_DESIRED_TEMP ; Iste yeni hedef sicaklik!
    RETURN

; ---------------- ADC OKUMA & HESAP ----------------
READ_ADC:
    BANKSEL ADCON0
    BSF     ADCON0, 2
WAIT_ADC:
    BTFSC   ADCON0, 2
    GOTO    WAIT_ADC

    BANKSEL ADRESL
    MOVF    ADRESL, W
    BANKSEL ADC_LOW
    MOVWF   TEMP_RAW

    ; Kalibrasyon (Değer - Değer/32)
    MOVF    TEMP_RAW, W
    MOVWF   TEMP_OFFSET
    SWAPF   TEMP_OFFSET, F
    MOVLW   0x0F
    ANDWF   TEMP_OFFSET, F
    BCF     STATUS, 0
    RRF     TEMP_OFFSET, F
    
    MOVF    TEMP_OFFSET, W
    SUBWF   TEMP_RAW, W
    MOVWF   TEMP_CALIB

    ; Tam Sayı
    MOVF    TEMP_CALIB, W
    MOVWF   TEMP_RAW
    BCF     STATUS, 0
    RRF     TEMP_RAW, F
    
    ; Ondalık Kısım (0 veya 5)
    CLRF    DISP3           ; Önce 0 yap
    BTFSC   TEMP_CALIB, 0   ; Tek sayı mı?
    MOVLW   5               ; Evetse 5 yükle
    BTFSC   TEMP_CALIB, 0
    MOVWF   DISP3           ; Kaydet

    RETURN

; ---------------- BASAMAKLARA AYIRMA ----------------
SPLIT_DIGITS:
    CLRF    DISP1
    MOVF    TEMP_RAW, W

DIV10:
    ADDLW   -10
    BTFSS   STATUS, 0
    GOTO    DONE_DIV
    INCF    DISP1, F
    GOTO    DIV10

DONE_DIV:
    ADDLW   10
    MOVWF   DISP2
    RETURN

; ---------------- EKRAN TARAMA (DÜZELTİLDİ) ----------------
REFRESH_DISPLAY:
    ; Digitleri Kapat
    BCF     PORTE, 0
    BCF     PORTE, 1
    BCF     PORTE, 2
    BCF     PORTA, 5

    MOVLW   0x02
    MOVWF   PCLATH

    ; --- YENİ SEÇME MANTIĞI (BUG FIX) ---
    MOVF    DIGIT_VAR, W
    ANDLW   0x03           ; Sadece 0-3 arası
    MOVWF   DIGIT_TEMP     ; Sakla

    ; 0 mı? (Onlar)
    MOVF    DIGIT_TEMP, W
    XORLW   0
    BTFSC   STATUS, 2      ; Z=1 ise eşittir
    GOTO    SHOW_1

    ; 1 mi? (Birler)
    MOVF    DIGIT_TEMP, W
    XORLW   1
    BTFSC   STATUS, 2
    GOTO    SHOW_2

    ; 2 mi? (Ondalık - SORUN BURADAYDI)
    MOVF    DIGIT_TEMP, W
    XORLW   2
    BTFSC   STATUS, 2
    GOTO    SHOW_3

    ; 3 mü? (C harfi)
    GOTO    SHOW_4

SHOW_1: ; Onlar
    MOVF    DISP1, W
    CALL    GET_7SEG
    MOVWF   PORTD
    BSF     PORTE, 0
    INCF    DIGIT_VAR, F
    GOTO    FINISH

SHOW_2: ; Birler + NOKTA
    MOVF    DISP2, W
    CALL    GET_7SEG
    IORLW   10000000B      ; Noktayı yak
    MOVWF   PORTD
    BSF     PORTE, 1
    INCF    DIGIT_VAR, F
    GOTO    FINISH

SHOW_3: ; Ondalık (Artık Çalışacak!)
    MOVF    DISP3, W
    CALL    GET_7SEG
    MOVWF   PORTD
    BSF     PORTE, 2       ; RE2'yi yak
    INCF    DIGIT_VAR, F
    GOTO    FINISH

SHOW_4: ; C Harfi
    MOVF    DISP4, W
    CALL    GET_7SEG
    MOVWF   PORTD
    BSF     PORTA, 5
    CLRF    DIGIT_VAR
    GOTO    FINISH

FINISH:
    CLRF    PCLATH
    RETURN

; ---------------- GECİKME ----------------
DELAY_SMALL:
    MOVLW   50
    MOVWF   W_TEMP
DLY:
    DECFSZ  W_TEMP, F
    GOTO    DLY
    RETURN
; ---------------- KLIMA KONTROL MANTIGI (DUZELTILDI) ----------------
CHECK_TEMP_CONTROL:
    BANKSEL PORTC           ; PORTC bankina gec (Cikislar icin)
    
    ; --- DUZELTME BURADA ---
    ; TEMP_CALIB degil, TEMP_RAW kullanacagiz.
    ; Cunku TEMP_RAW, READ_ADC fonksiyonundan cikarken gercek dereceyi (orn: 25) tutuyor.
    
    MOVF    REQ_DESIRED_TEMP, W ; W = 25
    SUBWF   TEMP_RAW, W         ; W = Gercek Sicaklik - 25
    
    ; Eger Sonuc Pozitif (C=1) ise: Ortam >= Hedef -> SOGUTUCU AC
    ; Eger Sonuc Negatif (C=0) ise: Ortam < Hedef  -> ISITICI AC
    
    BTFSS   STATUS, 0       ; Carry (C) biti kontrolu
    GOTO    TURN_ON_HEATER  ; C=0 ise sonuc negatiftir (Ortam soguk)

TURN_ON_COOLER:
    ; Ortam sicak (veya esit), sogutucuyu ac (RC1), isiticiyi kapat (RC0)
    BCF     PORTC, 0        ; Isitici Kapat
    BSF     PORTC, 1        ; Sogutucu AC (Fan Donmeli)
    RETURN

TURN_ON_HEATER:
    ; Ortam soguk, isiticiyi ac (RC0), sogutucuyu kapat (RC1)
    BCF     PORTC, 1        ; Sogutucu Kapat
    BSF     PORTC, 0        ; Isitici AC (Sicaklik Artmali)
    RETURN
; ---------------- KEYPAD TARAMA ----------------
SCAN_KEYPAD:
    CLRF    KEY_FLAG        ; Bayragi temizle
    BANKSEL PORTB
    
    ; --- SATIR 1 (RB0) TARAMA ---
    MOVLW   11111110B       ; RB0 Low, Digerleri High
    MOVWF   PORTB
    NOP                     ; Sinyalin oturmasi icin bekle
    NOP
    ; Sutunlari Kontrol Et (RB4, RB5, RB6, RB7)
    BTFSS   PORTB, 4        ; RB4 Low oldu mu? (Tus: 1)
    GOTO    KEY_1
    BTFSS   PORTB, 5        ; RB5 Low oldu mu? (Tus: 2)
    GOTO    KEY_2
    BTFSS   PORTB, 6        ; RB6 Low oldu mu? (Tus: 3)
    GOTO    KEY_3
    BTFSS   PORTB, 7        ; RB7 Low oldu mu? (Tus: A)
    GOTO    KEY_A

    ; --- SATIR 2 (RB1) TARAMA ---
    MOVLW   11111101B       ; RB1 Low
    MOVWF   PORTB
    NOP
    NOP
    BTFSS   PORTB, 4        ; (Tus: 4)
    GOTO    KEY_4
    BTFSS   PORTB, 5        ; (Tus: 5)
    GOTO    KEY_5
    BTFSS   PORTB, 6        ; (Tus: 6)
    GOTO    KEY_6
    BTFSS   PORTB, 7        ; (Tus: B)
    GOTO    KEY_B

    ; --- SATIR 3 (RB2) TARAMA ---
    MOVLW   11111011B       ; RB2 Low
    MOVWF   PORTB
    NOP
    NOP
    BTFSS   PORTB, 4        ; (Tus: 7)
    GOTO    KEY_7
    BTFSS   PORTB, 5        ; (Tus: 8)
    GOTO    KEY_8
    BTFSS   PORTB, 6        ; (Tus: 9)
    GOTO    KEY_9
    BTFSS   PORTB, 7        ; (Tus: C)
    GOTO    KEY_C

    ; --- SATIR 4 (RB3) TARAMA ---
    MOVLW   11110111B       ; RB3 Low
    MOVWF   PORTB
    NOP
    NOP
    BTFSS   PORTB, 4        ; (Tus: *)
    GOTO    KEY_YILDIZ
    BTFSS   PORTB, 5        ; (Tus: 0)
    GOTO    KEY_0
    BTFSS   PORTB, 6        ; (Tus: #)
    GOTO    KEY_KARE
    BTFSS   PORTB, 7        ; (Tus: D)
    GOTO    KEY_D

    RETURN                  ; Hiçbir tusa basilmadiysa don

; --- TUS ATAMALARI ---
KEY_1:
    MOVLW   1
    GOTO    KEY_FOUND
KEY_2:
    MOVLW   2
    GOTO    KEY_FOUND
KEY_3:
    MOVLW   3
    GOTO    KEY_FOUND
KEY_A:
    MOVLW   0x0A            ; A Harfi
    GOTO    KEY_FOUND
KEY_4:
    MOVLW   4
    GOTO    KEY_FOUND
KEY_5:
    MOVLW   5
    GOTO    KEY_FOUND
KEY_6:
    MOVLW   6
    GOTO    KEY_FOUND
KEY_B:
    MOVLW   0x0B            ; B Harfi
    GOTO    KEY_FOUND
KEY_7:
    MOVLW   7
    GOTO    KEY_FOUND
KEY_8:
    MOVLW   8
    GOTO    KEY_FOUND
KEY_9:
    MOVLW   9
    GOTO    KEY_FOUND
KEY_C:
    MOVLW   0x0C            ; C Harfi
    GOTO    KEY_FOUND
KEY_YILDIZ:
    MOVLW   0x0E            ; Yildiz (E olarak kodlayalim)
    GOTO    KEY_FOUND
KEY_0:
    MOVLW   0
    GOTO    KEY_FOUND
KEY_KARE:
    MOVLW   0x0F            ; Kare (F olarak kodlayalim)
    GOTO    KEY_FOUND
KEY_D:
    MOVLW   0x0D            ; D Harfi
    GOTO    KEY_FOUND

KEY_FOUND:
    MOVWF   KEY_CODE        ; Tus kodunu sakla
    MOVLW   1
    MOVWF   KEY_FLAG        ; Bayragi kaldir (Tus bulundu)
    
    ; --- TUS BIRAKILANA KADAR BEKLE (Debounce) ---
    ; Eger bunu yapmazsak "1"e basinca ekrana "111111" yazar.
    ; Basit debounce: Tus basili oldugu surece burada bekle.
TU_BIRAK_BEKLE:
    ; Ayni satiri kontrol et, eger hala low ise bekle
    ; Basit cozum: Kisa bir gecikme verip cikabiliriz ama en iyisi beklemektir.
    CALL    DELAY_SMALL
    ; Tamami 1 mi diye bakmak karmasik olabilir, simdilik gecikme ile yetinelim.
    ; Kullanici elini hizli cekmeli :)
    CALL    DELAY_SMALL
    CALL    DELAY_SMALL
    RETURN

    END
